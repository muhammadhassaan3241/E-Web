module.exports = function(params){

	var WebSocketServer = require('ws').Server
	  , wss = new WebSocketServer(params)
	  , debug = process.env.debug;
	
	if(debug) console.log('starting socket server', params);

	wss.clientlist = {};

	wss.sendAll = function(s){
		for(i in this.clientlist){
			this.send(i, typeof(s) === 'object' ? JSON.stringify(s) : s);
		}
	}

	wss.send = function(id, s){
		if(debug) console.log('sending to', id);
		try {
			this.clientlist[id].send(s);
		} catch(e){
			throw e;
		}
	}

	wss.return = function(e, r){
		wss.sendAll({e: e, r: r});
	}

	wss.hook = function(ws){ ws.deny = false; return ws }
	wss.onmessage = console.log;

	wss.on('connection', function(ws) {
			if(debug) console.log('connection attempt');
			ws = wss.hook(ws);
			if(('undefined' !== typeof(ws.deny)) && ws.deny){
				if(debug) console.log('connection denied');
				return ws.close();
			}
			ws._id = Math.random().toString(36).slice(10);
			wss.clientlist[ws._id] = ws;
			if(debug) console.log('connection', ws._id);

			ws.on('message', function(s){
				wss.onmessage(s);
			})

			ws.send(ws._id);
			ws.on('close', function(){
				if(debug) console.log('closing', ws._id);
				delete wss.clientlist[ws._id];
			})
	})

	return wss;
}